datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum DiscountType {
  NONE
  PERCENT
}

enum EventType {
  DEAL_VIEW
  MERCHANT_PROFILE_VIEW
}

model Merchant {
  id String @id @default(uuid()) @db.Uuid

  userId String? @unique @db.Uuid

  name        String
  description String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    String?
  address     String?
  city        String?
  phone       String?
  website     String?
  lat         Float?
  lng         Float?

  deals Deal[]

  // ðŸ‘‡ needed for Prisma relations
  events Event[]
}

model Deal {
  id          String @id @default(uuid()) @db.Uuid
  title       String
  description String

  originalPrice Int?
  shortCode     String? @unique

  discountValue Int          @default(0)
  discountType  DiscountType @default(NONE)

  imageUrl       String?
  maxRedemptions Int?

  startsAt DateTime
  endsAt   DateTime

  merchantId String   @db.Uuid
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  redemptions Redemption[]

  requestedBlockLogs RedemptionBlockLog[] @relation("RequestedDeal")
  blockedBlockLogs   RedemptionBlockLog[] @relation("BlockedDeal")

  // ðŸ‘‡ needed for Prisma relations
  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Redemption {
  id String @id @default(uuid()) @db.Uuid

  dealId String @db.Uuid
  deal   Deal   @relation(fields: [dealId], references: [id])

  code      String @unique
  shortCode String @unique

  redeemedAt DateTime?
  expiresAt  DateTime

  deviceHash String?
  activeKey  String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([dealId, redeemedAt])
  @@index([expiresAt])
}

model RedemptionBlockLog {
  id String @id @default(uuid()) @db.Uuid

  createdAt  DateTime @default(now()) @map("created_at")
  deviceHash String   @map("device_hash")

  requestedDealId String @map("requested_deal_id") @db.Uuid
  requestedDeal   Deal   @relation("RequestedDeal", fields: [requestedDealId], references: [id], onDelete: Cascade)

  blockedDealId String? @map("blocked_deal_id") @db.Uuid
  blockedDeal   Deal?   @relation("BlockedDeal", fields: [blockedDealId], references: [id], onDelete: SetNull)

  blockedShortCode String?   @map("blocked_short_code")
  blockedExpiresAt DateTime? @map("blocked_expires_at")

  reason        String
  retryAfterSec Int?    @map("retry_after_sec")
  userAgent     String? @map("user_agent")

  @@index([createdAt])
  @@index([deviceHash])
  @@index([requestedDealId])
  @@index([blockedDealId])
  @@index([reason])
  @@map("RedemptionBlockLog")
}

model Event {
  id String @id @default(uuid()) @db.Uuid

  type       EventType
  deviceHash String

  // ðŸ‘‡ dedupe key: one view per device per day per target
  dayKey String @db.VarChar(128)

  merchantId String?   @db.Uuid
  merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  dealId String? @db.Uuid
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([dayKey])
  @@index([type, createdAt])
  @@index([merchantId, createdAt])
  @@index([dealId, createdAt])
  @@map("Event")
}
