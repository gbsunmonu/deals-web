datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum DiscountType {
  NONE
  PERCENT
}

/**
 * ✅ Single EventType enum (extends your existing one)
 * IMPORTANT:
 * - Do NOT define a second EventType enum anywhere else.
 * - Keep existing values to match your DB.
 */
enum EventType {
  DEAL_VIEW
  MERCHANT_PROFILE_VIEW

  // added (visitor tracking)
  EXPLORE_VIEW
  EXPLORE_SEARCH
  DEAL_REDEEM_CLICK
  DEAL_REDEEM_SUCCESS
}

model Merchant {
  id String @id @default(uuid()) @db.Uuid

  userId String? @unique @db.Uuid

  name        String
  description String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    String?
  address     String?
  city        String?
  phone       String?
  website     String?
  lat         Float?
  lng         Float?

  deals Deal[]

  events Event[]
}

model Deal {
  id          String @id @default(uuid()) @db.Uuid
  title       String
  description String

  originalPrice Int?

  shortCode String? @unique

  discountValue Int          @default(0)
  discountType  DiscountType @default(NONE)

  imageUrl String?

  maxRedemptions Int?

  startsAt DateTime
  endsAt   DateTime

  merchantId String   @db.Uuid
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  redemptions Redemption[]

  requestedBlockLogs RedemptionBlockLog[] @relation("RequestedDeal")
  blockedBlockLogs   RedemptionBlockLog[] @relation("BlockedDeal")

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Redemption {
  id String @id @default(uuid()) @db.Uuid

  dealId String @db.Uuid
  deal   Deal   @relation(fields: [dealId], references: [id])

  code      String @unique
  shortCode String @unique

  redeemedAt DateTime?

  expiresAt DateTime

  deviceHash String?
  activeKey  String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([dealId, redeemedAt])
  @@index([expiresAt])
}

model RedemptionBlockLog {
  id String @id @default(uuid()) @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  deviceHash String @map("device_hash")

  requestedDealId String @map("requested_deal_id") @db.Uuid
  requestedDeal   Deal   @relation("RequestedDeal", fields: [requestedDealId], references: [id], onDelete: Cascade)

  blockedDealId String? @map("blocked_deal_id") @db.Uuid
  blockedDeal   Deal?   @relation("BlockedDeal", fields: [blockedDealId], references: [id], onDelete: SetNull)

  blockedShortCode String?   @map("blocked_short_code")
  blockedExpiresAt DateTime? @map("blocked_expires_at")

  reason String

  retryAfterSec Int?    @map("retry_after_sec")
  userAgent     String? @map("user_agent")

  @@index([createdAt])
  @@index([deviceHash])
  @@index([requestedDealId])
  @@index([blockedDealId])
  @@index([reason])
  @@map("RedemptionBlockLog")
}

/**
 * ✅ NEW: persistent anonymous visitor profile
 * We store the cookie UUID as VisitorProfile.id (simple and Prisma-friendly).
 */
model VisitorProfile {
  id String @id @default(uuid()) @db.Uuid

  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  lastPath  String?
  userAgent String?
  ipHash    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]

  @@index([lastSeenAt])
  @@map("VisitorProfile")
}

/**
 * ✅ Keep your EXISTING Event table/model, just add visitorId + optional metadata.
 * NOTE: visitorId is optional so you can deploy safely even before backfill.
 */
model Event {
  id String @id @default(uuid()) @db.Uuid

  type EventType
  deviceHash String

  dayKey String @unique @db.VarChar(128)

  // ✅ NEW: visitor FK (nullable for safety)
  visitorId String?         @db.Uuid
  visitor   VisitorProfile? @relation(fields: [visitorId], references: [id], onDelete: SetNull)

  merchantId String?   @db.Uuid
  merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  dealId String? @db.Uuid
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: SetNull)

  city      String?
  userAgent String?
  ipHash    String?

  createdAt DateTime @default(now())

  @@index([type, createdAt])
  @@index([deviceHash, createdAt])
  @@index([visitorId, createdAt])
  @@index([merchantId, createdAt])
  @@index([dealId, createdAt])
  @@index([dayKey])
  @@map("Event")
}
