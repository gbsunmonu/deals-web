// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum DiscountType {
  NONE
  PERCENT
}

enum EventType {
  DEAL_VIEW
  MERCHANT_PROFILE_VIEW
  EXPLORE_VIEW
  EXPLORE_SEARCH
  DEAL_REDEEM_CLICK
  DEAL_REDEEM_SUCCESS
  WHATSAPP_CLICK
}

enum MerchantStatus {
  PENDING
  VERIFIED
  SUSPENDED
}

model Merchant {
  id String @id @default(uuid()) @db.Uuid

  name        String
  description String?
  avatarUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category String?
  address  String?
  city     String?
  phone    String?
  website  String?
  lat      Float?
  lng      Float?

  userId String? @unique

  whatsappNumber String? @map("whatsapp_number")

  status          MerchantStatus @default(PENDING)
  verifiedAt      DateTime?
  statusReason    String?
  statusUpdatedAt DateTime @default(now())

  deals  Deal[]
  events Event[]

  @@map("Merchant")
}

model Deal {
  id String @id @default(uuid()) @db.Uuid

  title       String
  description String

  discountValue Int
  discountType  DiscountType

  imageUrl String?

  startsAt DateTime
  endsAt   DateTime

  merchantId String   @db.Uuid
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  originalPrice Int?
  shortCode     String? @unique
  maxRedemptions Int?

  repostedFromId String? @db.Uuid
  repostedFrom   Deal?   @relation("DealReposts", fields: [repostedFromId], references: [id], onDelete: SetNull)
  reposts        Deal[]  @relation("DealReposts")

  redemptions Redemption[]
  events      Event[]

  @@index([merchantId, createdAt])
  @@index([startsAt, endsAt])
  @@index([repostedFromId])

  @@map("Deal")
}

model Redemption {
  id String @id @default(uuid()) @db.Uuid

  dealId String @db.Uuid
  deal   Deal   @relation(fields: [dealId], references: [id])

  code      String @unique
  shortCode String @unique

  redeemedAt DateTime?
  expiresAt  DateTime

  deviceHash String?
  activeKey  String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([dealId, redeemedAt])
  @@index([expiresAt])

  @@map("Redemption")
}

model VisitorProfile {
  // DB: VisitorProfile.id is uuid
  id String @id @db.Uuid

  // DB requires visitor_id NOT NULL (text)
  visitorId String @unique @map("visitor_id")

  firstSeenAt DateTime @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")

  lastPath  String? @map("last_path")
  userAgent String? @map("user_agent")
  ipHash    String? @map("ip_hash")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ✅ now has an opposite field in Event
  events Event[]

  @@map("VisitorProfile")
}

model Event {
  id String @id @default(uuid()) @db.Uuid

  type EventType

  deviceHash String

  merchantId String? @db.Uuid
  dealId     String? @db.Uuid

  createdAt DateTime @default(now())

  dayKey String @unique @db.VarChar(128)
  meta   Json?

  // DB: Event.visitorId is uuid (and matches VisitorProfile.id)
  visitorId String? @db.Uuid

  // ✅ opposite relation field
  visitor VisitorProfile? @relation(fields: [visitorId], references: [id], onDelete: SetNull)

  city      String?
  userAgent String?
  ipHash    String?

  merchant Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)
  deal     Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
  @@index([deviceHash, createdAt])
  @@index([visitorId, createdAt])
  @@index([merchantId, createdAt])
  @@index([dealId, createdAt])

  @@map("Event")
}

model TrackDropLog {
  id String @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now())

  reason String

  type       String?
  visitorId  String?
  deviceHash String?
  ipHash     String?
  userAgent  String?
  path       String?

  dealId     String?
  merchantId String?

  dayKey String?

  @@index([createdAt])
  @@index([reason, createdAt])
  @@index([type, createdAt])

  @@map("TrackDropLog")
}
