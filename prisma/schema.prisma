// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum DiscountType {
  NONE
  PERCENT
}

model Merchant {
  id String @id @default(uuid()) @db.Uuid

  // Link to Supabase auth user (nullable but unique)
  // (Supabase auth user ids are UUIDs)
  userId String? @unique @db.Uuid

  name        String
  description String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    String?
  address     String?
  city        String?
  phone       String?
  website     String?
  lat         Float?
  lng         Float?

  deals Deal[]
}

model Deal {
  id          String @id @default(uuid()) @db.Uuid
  title       String
  description String

  originalPrice Int?

  shortCode String? @unique

  discountValue Int          @default(0)
  discountType  DiscountType @default(NONE)

  imageUrl String?

  // ✅ how many times the deal can be redeemed total (null/0 = unlimited)
  maxRedemptions Int?

  startsAt DateTime
  endsAt   DateTime

  merchantId String   @db.Uuid
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  redemptions Redemption[]

  // ✅ REQUIRED: opposite relation fields for RedemptionBlockLog
  requestedBlockLogs RedemptionBlockLog[] @relation("RequestedDeal")
  blockedBlockLogs   RedemptionBlockLog[] @relation("BlockedDeal")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Redemption {
  id String @id @default(uuid()) @db.Uuid

  dealId String @db.Uuid
  deal   Deal   @relation(fields: [dealId], references: [id])

  code      String @unique
  shortCode String @unique

  redeemedAt DateTime?

  // ✅ QR expiry (set in code when creating QR)
  expiresAt DateTime?

  // ✅ device lock (optional until you fully enforce it)
  deviceHash String?

  // ✅ unique active lock key while QR is active
  activeKey String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([dealId, redeemedAt])
  @@index([expiresAt])
}

model RedemptionBlockLog {
  id String @id @default(uuid()) @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  deviceHash String @map("device_hash")

  requestedDealId String @db.Uuid @map("requested_deal_id")
  requestedDeal   Deal   @relation("RequestedDeal", fields: [requestedDealId], references: [id], onDelete: Cascade)

  blockedDealId String? @db.Uuid @map("blocked_deal_id")
  blockedDeal   Deal?   @relation("BlockedDeal", fields: [blockedDealId], references: [id], onDelete: SetNull)

  blockedShortCode String?   @map("blocked_short_code")
  blockedExpiresAt DateTime? @map("blocked_expires_at")

  reason String

  retryAfterSec Int?    @map("retry_after_sec")
  userAgent     String? @map("user_agent")

  @@index([createdAt])
  @@index([deviceHash])
  @@index([requestedDealId])
  @@index([blockedDealId])
  @@index([reason])

  @@map("RedemptionBlockLog")
}
